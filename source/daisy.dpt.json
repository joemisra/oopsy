{
  "name": "DPT",
  "description": "Daisy Patch Toolkit - Extended Eurorack module with DAC7554, MIDI, and Gate I/O",
  "based_on": "patch_sm",
  
  "defines": {
    "OOPSY_TARGET_DPT": 1,
    "OOPSY_TARGET_HAS_MIDI_INPUT": 1,
    "OOPSY_TARGET_HAS_MIDI_OUTPUT": 1,
    "OOPSY_TARGET_HAS_GATE_INPUT": 1,
    "OOPSY_TARGET_HAS_GATE_OUTPUT": 1,
    "OOPSY_TARGET_HAS_EXTERNAL_DAC": 1,
    "OOPSY_IO_COUNT": 2
  },

  "inserts": [
    { "where": "header", "code": "#include \"daisy_dpt.h\"" },
    { "where": "header", "code": "typedef daisy::dpt::DPT Daisy;" },
    { "where": "header", "code": "static float dac7554_cv3 = 0.f, dac7554_cv4 = 0.f, dac7554_cv5 = 0.f, dac7554_cv6 = 0.f;" },
    { "where": "init", "code": "oopsy::daisy.hardware.InitMidi();" },
    { "where": "init", "code": "oopsy::daisy.hardware.midi.StartReceive();" },
    { "where": "init", "code": "oopsy::daisy.hardware.StartDacExp(nullptr);" }
  ],

  "labels": {
    "params": {
      "cv1": "cv1",
      "cv2": "cv2",
      "cv3": "cv3",
      "cv4": "cv4",
      "cv5": "cv5",
      "cv6": "cv6",
      "cv7": "cv7",
      "cv8": "cv8",
      "gate1": "gate1",
      "gate2": "gate2",
      "gate1_trig": "gate1_trig",
      "gate2_trig": "gate2_trig",
      "gate": "gate1",
      "trig1": "gate1_trig",
      "trig2": "gate2_trig",
      "trig": "gate1_trig",
      "cv": "cv1",
      "knob1": "cv1",
      "knob2": "cv2",
      "knob3": "cv3",
      "knob4": "cv4"
    },
    "outs": {
      "cvout1": "cvout1",
      "cvout2": "cvout2",
      "cvout3": "cvout3",
      "cvout4": "cvout4",
      "cvout5": "cvout5",
      "cvout6": "cvout6",
      "cv1": "cvout1",
      "cv2": "cvout2",
      "cv3": "cvout3",
      "cv4": "cvout4",
      "cv5": "cvout5",
      "cv6": "cvout6",
      "out3": "cvout3",
      "out4": "cvout4",
      "out5": "cvout5",
      "out6": "cvout6",
      "out7": "cvout1",
      "out8": "cvout2",
      "gateout1": "gateout1",
      "gateout2": "gateout2",
      "gate1": "gateout1",
      "gate2": "gateout2",
      "gate": "gateout1",
      "gate_out_1": "gateout1",
      "gate_out_2": "gateout2",
      "led": "cvout1"
    },
    "datas": {}
  },

  "inputs": {
    "cv1": {
      "automap": true,
      "code": "hardware.GetAdcValue(daisy::dpt::CV_1)"
    },
    "cv2": {
      "automap": true,
      "code": "hardware.GetAdcValue(daisy::dpt::CV_2)"
    },
    "cv3": {
      "automap": true,
      "code": "hardware.GetAdcValue(daisy::dpt::CV_3)"
    },
    "cv4": {
      "automap": true,
      "code": "hardware.GetAdcValue(daisy::dpt::CV_4)"
    },
    "cv5": {
      "automap": true,
      "code": "hardware.GetAdcValue(daisy::dpt::CV_5)"
    },
    "cv6": {
      "automap": true,
      "code": "hardware.GetAdcValue(daisy::dpt::CV_6)"
    },
    "cv7": {
      "automap": true,
      "code": "hardware.GetAdcValue(daisy::dpt::CV_7)"
    },
    "cv8": {
      "automap": true,
      "code": "hardware.GetAdcValue(daisy::dpt::CV_8)"
    },
    "gate1": {
      "code": "(hardware.gate_in_1.State() ? 1.f : 0.f)"
    },
    "gate2": {
      "code": "(hardware.gate_in_2.State() ? 1.f : 0.f)"
    },
    "gate1_trig": {
      "code": "(hardware.gate_in_1_trig ? 1.f : 0.f)"
    },
    "gate2_trig": {
      "code": "(hardware.gate_in_2_trig ? 1.f : 0.f)"
    }
  },

  "outputs": {
    "cvout1": {
      "where": "main",
      "code": "hardware.WriteCvOut(daisy::dpt::CV_OUT_1, $<name> * 7.f, false);"
    },
    "cvout2": {
      "where": "main",
      "code": "hardware.WriteCvOut(daisy::dpt::CV_OUT_2, $<name> * 7.f, false);"
    },
    "cvout3": {
      "where": "main",
      "code": "extern float dac7554_cv3; dac7554_cv3 = $<name> * 7.f;"
    },
    "cvout4": {
      "where": "main",
      "code": "extern float dac7554_cv4; dac7554_cv4 = $<name> * 7.f;"
    },
    "cvout5": {
      "where": "main",
      "code": "extern float dac7554_cv5; dac7554_cv5 = $<name> * 7.f;"
    },
    "cvout6": {
      "where": "main",
      "code": "extern float dac7554_cv3, dac7554_cv4, dac7554_cv5, dac7554_cv6; dac7554_cv6 = $<name> * 7.f; hardware.WriteCvOutExp(dac7554_cv3, dac7554_cv4, dac7554_cv5, dac7554_cv6, false);"
    },
    "gateout1": {
      "where": "audio",
      "code": "dsy_gpio_write(&hardware.gate_out_1, $<name> > 0.f);"
    },
    "gateout2": {
      "where": "audio",
      "code": "dsy_gpio_write(&hardware.gate_out_2, $<name> > 0.f);"
    }
  },

  "datahandlers": {},

  "notes": {
    "audio": "DPT supports stereo audio I/O (24-bit @ 48kHz)",
    "cv_outputs": "cvout1-2 use native DAC (0-5V), cvout3-6 use DAC7554 (-7V to +7V)",
    "gate_io": "2 gate inputs (gate1, gate2) and 2 gate outputs (gateout1, gateout2)",
    "midi": "MIDI I/O via UART on pins A8 (TX) and A9 (RX)",
    "cv_inputs": "8 CV inputs (cv1-cv8) with configurable range"
  }
}
